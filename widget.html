<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget - Song Spinner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: transparent; overflow: hidden; }
        .rarity-border-Common    { border-color: #9CA3AF; box-shadow: 0 0 20px #9CA3AF; }
        .rarity-border-Rare      { border-color: #3B82F6; box-shadow: 0 0 20px #3B82F6; }
        .rarity-border-Legendary { border-color: #EAB308; box-shadow: 0 0 20px #EAB308; }
        .container-base { position: fixed; opacity: 0; transition: opacity 0.5s ease-in-out; pointer-events: none; }
        #spin-animation-wrapper, #result-container { top: 50%; left: 50%; transform: translate(-50%, -50%); }
        #flicker-image { width: 250px; height: 250px; object-fit: cover; border-radius: 20px; border: 8px solid white; }
        #result-container { width: 90vw; max-width: 500px; background: rgba(17, 24, 39, 0.9); border-radius: 15px; padding: 24px; text-align: center; }
        .text-shadow { text-shadow: 2px 2px 4px rgba(0,0,0,0.7); }
    </style>
</head>
<body>
    <!-- Unlock overlay has been removed -->

    <div id="spin-animation-wrapper" class="container-base flex flex-col items-center gap-4">
        <div class="flex items-center gap-3 p-2 bg-gray-900/80 rounded-lg"><img id="donator-avatar" class="w-12 h-12 rounded-full"><div><p class="text-sm text-gray-400 -mb-1">สุ่มเพลงสำหรับ:</p><p id="donator-name" class="text-xl font-bold"></p></div></div>
        <div><img id="flicker-image" src="https://placehold.co/250x250/111827/transparent?text=?"></div>
    </div>
    <div id="result-container" class="container-base">
        <img id="result-song-cover" class="w-32 h-32 rounded-lg mx-auto border-4 shadow-lg mb-4">
        <h1 id="result-item-name" class="text-4xl font-black text-shadow"></h1>
        <p id="result-item-rarity" class="text-lg font-bold text-shadow mb-4"></p>
        <div class="w-full bg-gray-600 rounded-full h-2.5"><div id="progress-bar" class="bg-green-500 h-2.5 rounded-full" style="width: 0%"></div></div>
        <p id="result-song-duration" class="mt-1 text-sm text-gray-400">00:00 / 00:00</p>
        <div class="mt-4 border-t border-gray-600 pt-3"><p class="text-sm">ขอโดย:</p><div class="flex items-center justify-center gap-3 mt-1"><img id="sender-avatar" class="w-10 h-10 rounded-full"><p id="sender-name" class="text-lg font-bold"></p></div></div>
    </div>
    <audio id="audio-player" playsinline></audio>
    <script>
        const spinWrapper = document.getElementById('spin-animation-wrapper');
        const flickerImage = document.getElementById('flicker-image');
        const donatorAvatar = document.getElementById('donator-avatar');
        const donatorName = document.getElementById('donator-name');
        const resultContainer = document.getElementById('result-container');
        const audioPlayer = document.getElementById('audio-player');
        const resultCover = document.getElementById('result-song-cover');
        const resultName = document.getElementById('result-item-name');
        const resultRarity = document.getElementById('result-item-rarity');
        const progressBar = document.getElementById('progress-bar');
        const durationText = document.getElementById('result-song-duration');
        const senderAvatar = document.getElementById('sender-avatar');
        const senderName = document.getElementById('sender-name');

        const rarities = {
            Common: { color: 'rarity-border-Common' },
            Rare: { color: 'rarity-border-Rare' },
            Legendary: { color: 'rarity-border-Legendary' }
        };
        let spinQueue = [], isBusy = false, lastProcessedTriggerId = null, currentPayload = null;

        function processQueue() {
            if (isBusy || spinQueue.length === 0) return;
            isBusy = true;
            currentPayload = spinQueue.shift();
            startFlickerAnimation(currentPayload);
        }
        function startFlickerAnimation(payload) {
            donatorAvatar.src = payload.senderInfo.profilePictureUrl;
            donatorName.textContent = payload.senderInfo.name;
            spinWrapper.style.opacity = 1;
            let count = 0;
            const totalFlickers = 20;
            const interval = setInterval(() => {
                const random = payload.spinnerItems[Math.floor(Math.random() * payload.spinnerItems.length)];
                flickerImage.src = random.cover;
                flickerImage.className = `w-full h-full object-cover rounded-20px border-8 ${rarities[random.rarity].color}`;
                if (++count >= totalFlickers) {
                    clearInterval(interval);
                    flickerImage.src = payload.winningItem.cover;
                    flickerImage.className = `w-full h-full object-cover rounded-20px border-8 ${rarities[payload.winningItem.rarity].color}`;
                    setTimeout(() => {
                        spinWrapper.style.opacity = 0;
                        showResult(payload);
                    }, 1000);
                }
            }, 100);
        }
        function showResult({ winningItem, senderInfo }) {
            resultCover.src = winningItem.cover;
            resultCover.className = `w-32 h-32 rounded-lg mx-auto border-4 shadow-lg mb-4 ${rarities[winningItem.rarity].color}`;
            resultName.textContent = winningItem.name;
            resultRarity.textContent = winningItem.rarity;
            resultRarity.className = `text-lg font-bold text-shadow text-white`;
            senderAvatar.src = senderInfo.profilePictureUrl;
            senderName.textContent = `${senderInfo.name} (${senderInfo.giftName} x${senderInfo.repeatCount})`;
            resultContainer.style.opacity = 1;
            audioPlayer.src = winningItem.songUrl;
            
            // Attempt to play audio automatically
            const playPromise = audioPlayer.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.error("Audio autoplay was blocked by the browser:", error);
                    // Display an error message on the widget itself if autoplay fails
                    resultName.textContent = "เสียงถูกบล็อกโดยเบราว์เซอร์";
                    durationText.textContent = "จำเป็นต้องใช้ฟังก์ชัน 'โต้ตอบ'";
                });
            }
        }
        
        setInterval(() => {
            const data = localStorage.getItem('tiktok_spin_trigger');
            if (data) {
                const payload = JSON.parse(data);
                if (payload.triggerId !== lastProcessedTriggerId) {
                    lastProcessedTriggerId = payload.triggerId;
                    spinQueue.push(payload);
                    processQueue();
                }
            }
        }, 500);

        audioPlayer.addEventListener('timeupdate', () => {
            if (!audioPlayer.duration) return;
            const p = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            progressBar.style.width = `${p}%`;
            const format = s => new Date(s * 1000).toISOString().substr(14, 5);
            durationText.textContent = `${format(audioPlayer.currentTime)} / ${format(audioPlayer.duration)}`;
        });

        audioPlayer.addEventListener('ended', () => {
            resultContainer.style.opacity = 0;
            if (currentPayload) {
                localStorage.setItem('tiktok_spin_ended', currentPayload.triggerId);
            }
            setTimeout(() => {
                isBusy = false;
                progressBar.style.width = '0%';
                processQueue();
            }, 500);
        });
    </script>
</body>
</html>
